---
title: "Reasons for School Bus Delay "
date: 
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    always_allow_html: true
    css: style.css
---

<br></br> 


## Description

\ The goal of the analyses is to understand what factors may contribute to the school bus delay in Manhattan from Fall 2018 to Fall 2021. We hypothesized that the heavy traffic and weather conditions may be important factors that lead to bus delay.Because of the changable weather in fall and winter, rains and snows may lead to bad road condition and more accidents. Therefore, heavy traffic are prone to occur,causing bus delay. 
We use the data collecting from school bus vendors operating out in the field in real time.Within the dataset, the contributing factors include like accident, delayed by school, flat tire, heavy traffic, late return from field trip, mechanical problem,problem run, weather conditions,bus won't start, and other.

<br></br>  
```{r setup, include=FALSE}
library(tidyverse)
library(plotly)
library(scales)
library(ggplot2)
library(patchwork)
library(viridis)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
theme_set(theme_minimal() + theme(legend.position = "right"))

```
<br></br>


## Top Contributing Factors for Bus Delay in Manhattan

```{r,message=FALSE}
#Import data
 df=read_csv("data/clean_data.csv")
```

```{r,message=FALSE}
#plot data: drop NA rows
plot_df = df %>% 
  filter(boro =="Manhattan",
         year %in% c(2018,2019,2020,2021),
         school_year!="2021-2022") %>%
  select(year,school_year,reason, day,month,prcp:tmin) %>% 
  na.omit()
```

```{r,message=FALSE}
plot_1= plot_df %>% 
  group_by(reason,school_year) %>% 
  summarize(frequency=n())%>%
  mutate(reason = as.factor(reason),
    reason = fct_reorder(reason,frequency,.desc = TRUE))%>% 
  ggplot(aes(x = reason, y = frequency,fill=reason)) + 
  geom_bar(stat='identity')+
  facet_grid(.~school_year,scales = "free") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust = 1), legend.position = "none") +
  labs(
    title = "Top Contributing Factors for Bus Delay in Manhattan in Count ",
    x = "Reason",
    y = "Frequency"
  ) 
ggplotly(plot_1)
```

```{r,message=FALSE}
plot_df %>% 
  filter(school_year!="2021-2022") %>% 
  group_by(reason,school_year) %>% 
  summarize(frequency=n()) %>% 
  pivot_wider(
    names_from = school_year,
    values_from = frequency)

plot_2=plot_df %>% 
  mutate(reason=fct_infreq(reason)) %>%
  ggplot(aes(x = school_year, fill = reason))+
  geom_bar()+
  labs(title = "The Contributing Factors for Bus Delay in each School Year")

ggplotly(plot_2)
```


```{r}
plot_3=plot_df %>% 
   filter(school_year!="2021-2022") %>% 
   group_by(school_year,reason) %>% 
   summarize(frequency=n()) %>% 
   ungroup(reason) %>% 
   filter(reason!= "Other") %>% 
   mutate(school_year=factor(school_year),
          school_year=fct_relevel(school_year,"2018-2019","2019-2020","2020-2021"),
          proportion=round(frequency/sum(frequency), 2),
          reason=factor(reason),
          reason=fct_reorder(reason,proportion,.desc = TRUE))

plot_3 %>% 
plot_ly(labels = ~reason, values = ~proportion, type = 'pie') %>% 
  layout(title = 'Top Reasons for Bus Delay')

plot_4=plot_3 %>% 
  ggplot(aes(x = reason, y = proportion, fill = school_year)) +
  geom_bar(stat = "identity") +
  facet_grid( . ~school_year, scales = "free_x", space = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust = 1), legend.position = "none") +
  labs(
    title = "The Top Contributing Factors for Bus Delay in each School Year in Percentage",
    x = "Reasons",
    y = "Proportion"
  ) 
ggplotly(plot_4)

```
\ As seen in the graph above, the leading contributing factors for bus delay was heavy traffic.It accounts for roughly 90% of reasons of delay.School year 2018-2019 had the greater number of school bus delay and had delayed for more than 30,000 times. Mechanical problem is the second reason for bus delay and it accounts for 6% of all reasons of bus delay.
Overall,the problem of bus delay has improved in the subsequent school year.




## Examine the association between number of heavy traffic and heavy rain across the school year

\ After looking at the graph, we did not see any association between heavy traffic and heavy rain across all school year. The distribution of rain is normally distributed across three school years. Weather in 2021-2022 is more spread and has greater variability within three categorical groups compared to weather in 2018-2019 and 2019-2020.
```{r}
plot_6=plot_df %>% 
  filter(school_year!="2021-2022",
         reason=="Heavy Traffic") %>% 
  mutate(
    prcp_hr=prcp/24,
    rain=case_when(
        prcp_hr == 0 ~"no rain",
        prcp_hr<2.5 ~ "light rain",
        prcp_hr<=7.6 ~ "moderate rain",
        prcp_hr>7.6 ~ "heavy rain"
  )) %>% 
  ggplot(aes(x=rain,fill=school_year))+
  geom_density(alpha = .4,adjust=1)+
  labs(
    title = "The Density Distribution for Rain across the School Years")
  
ggplotly(plot_6)


```

## Examine the association between reasons of bus delay and snow depth across the school year

```{r,message=FALSE}
plot_df %>% 
  select(school_year,snwd,reason) %>% 
  group_by(reason,school_year) %>% 
  summarize(mean=mean(snwd),
            reason_freq=n()) %>% 
  plot_ly( x =~reason, y=~mean, type = 'scatter', mode = 'markers',size = ~reason_freq,color =~school_year) %>% 
  layout(
    title = 'The Scatterplot for Snow Depth across the School Years',
    xaxis = list(
           tickangle=90))
```


## Examine the association between heavy traffic across the weekday
```{r}
plot_df %>% 
  group_by(day,reason) %>%
  summarise(n = n()) %>% 
  plot_ly(x = ~day, y = ~n, type = 'scatter',mode = 'line', color= ~ reason) %>%
  layout(
    title = 'Heavy Traffic Per Weekday',
    xaxis = list(
      type = 'category',
      title = 'Weekday'),
    yaxis = list(
      title = 'Count of Heavy Traffic'))
```
