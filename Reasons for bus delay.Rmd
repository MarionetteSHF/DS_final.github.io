---
title: "Reasons for School Bus Delay "
date: 
output: 
  html_document:
    code_folding: hide
    always_allow_html: true
    css: style.css
---

# Explore the factors that lead to school bus delay in Manhattan,New York

The goal of the analyses is to understand what factors may contribute to the school bus delay in Manhattan from Fall 2018 to Fall 2021. We hypothesized that the heavy traffic and weather conditions may be important factors that lead to bus delay.Because of the changable weather in fall and winter, rains and snows may lead to bad road condition and more accidents. Therefore, heavy traffic are prone to occur,causing bus delay. 
We use the data collecting from school bus vendors operating out in the field in real time.Within the dataset, the contributing factors include like accident, delayed by school, flat tire, heavy traffic, late return from field trip, mechanical problem,problem run, weather conditions,bus won't start, and other.


```{r setup, include=FALSE}
library(tidyverse)
library(plotly)
library(scales)
library(ggplot2)
library(patchwork)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
theme_set(theme_minimal() + theme(legend.position = "right"))

```

# Top Contributing Factors for Bus Delay

```{r,message=FALSE}
#Import data
 df=read_csv("data/clean_data.csv")
```


```{r,message=FALSE}
#plot data: drop NA rows
plot_df = df %>% 
  filter(boro =="Manhattan",
         year %in% c(2018,2019,2020,2021),
         school_year!="2021-2022") %>%
  select(year,school_year,reason, month,prcp:tmin) %>% 
  na.omit()

#plot factors 

plot_df %>% 
  count(reason) %>% 
  mutate(Reason= fct_reorder(reason, n)) %>% 
  plot_ly(x = ~Reason, y = ~n, color = ~reason, type = "bar", colors = "viridis")

```



```{r,message=FALSE}
plot_0= plot_df %>% 
  group_by(reason,school_year) %>% 
  summarize(frequency=n())%>%
  mutate(
    proportion=frequency/sum(frequency),
    reason = as.factor(reason),
    reason = fct_reorder(reason,frequency)) %>% 
  arrange(desc(frequency)) %>% 
  ggplot(aes(x = school_year, y = proportion)) + 
  geom_bar(stat='identity')+
  facet_wrap(.~reason,scales = "free") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust = 1), legend.position = "none") +
  labs(
    title = "Analyses the Reasons for bus delay in Manhattan across year",
    x = "year",
    y = "RF"
  ) 
ggplotly(plot_0)
```


```{r,message=FALSE}
plot_1= plot_df %>% 
  group_by(reason,school_year) %>% 
  summarize(frequency=n())%>%
  mutate(reason = as.factor(reason),
    reason = fct_reorder(reason,frequency)) %>% 
  ggplot(aes(x = reason, y = frequency)) + 
  geom_bar(stat='identity')+
  facet_grid(.~school_year,scales = "free") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust = 1), legend.position = "none") +
  labs(
    title = "Top contributing factors for bus delay in Manhattan",
    x = "Reason",
    y = "frequency"
  ) 
ggplotly(plot_1)
```

```{r,message=FALSE}
plot_df %>% 
  filter(school_year!="2021-2022") %>% 
  group_by(reason,school_year) %>% 
  summarize(frequency=n()) %>% 
  pivot_wider(
    names_from = school_year,
    values_from = frequency)

plot_2=plot_df %>% 
  mutate(reason = fct_infreq(reason)) %>%
  ggplot(aes(x = school_year, fill = reason))+
  geom_bar()

ggplotly(plot_2)
```


```{r}
plot_3=plot_df %>% 
   filter(school_year!="2021-2022") %>% 
   group_by(school_year,reason) %>% 
   summarize(frequency=n()) %>% 
   ungroup(reason) %>% 
   filter(reason!= "Other") %>% 
   mutate(school_year=factor(school_year),
          school_year=fct_relevel(school_year,"2018-2019","2019-2020","2020-2021"),
          proportion=round(frequency/sum(frequency), 2),
          reason=factor(reason),
          reason=fct_reorder(reason,proportion,.desc = TRUE)) %>% 
  ggplot(aes(x = reason, y = proportion, fill = school_year)) +
  geom_bar(stat = "identity") +
  facet_grid( . ~school_year, scales = "free_x", space = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust = 1), legend.position = "none") +
  labs(
    title = "The Top Contributing Factors for Bus Delay in each School Year",
    x = "Reasons",
    y = "Proportion"
  )
ggplotly(plot_3)
```

## Examine the association between number of heavy traffic and heavy rain across the school year

After looking at the graph, we did not see any association between heavy traffic and heavy rain across all school year.
```{r}
plot_df %>% 
  filter(school_year!="2021-2022",
         reason=="Heavy Traffic") %>% 
  mutate(
    prcp_hr=prcp/24,
    rain=case_when(
        prcp_hr == 0 ~"no rain",
        prcp_hr<2.5 ~ "light rain",
        prcp_hr<=7.6 ~ "moderate rain",
        prcp_hr>7.6 ~ "heavy rain"
  )) %>% 
  count(school_year,rain) %>%
  plot_ly(x = ~rain, y = ~n, color = ~school_year, type = "bar", colors = "viridis")
```


