---
title: "Hypothesis test"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(readxl)
library(patchwork)
library(plotly)
library(leaflet)
library(ggplot2)
library(lubridate)
knitr::opts_chunk$set(
  fig.height = 6,
  fig.width = 8,
  message = F,
  echo = T,
  warning = F,
  cache = F
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis",
  digits = 3
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Hypothesis Tests

### Chi-Square Testing Homogeneity between School Years and Delay Reasons

While looking at the reason of school bus delays, we see that heavy traffic is the main reason and all other reasons plays a minor part. This lead us to ask the question, whether the distribution of school bus delay reasons is the same across 2018-2021 school years.Though we include data in 2021-2022 Fall, yet the counts isn't comparable with other school years. So we only look at the 3 school years including, 2018-2019, 2019-2020, 2020-2021.

To answer our question, we conducted a chi-square test, with:

$H_0$ : The distribution of delay reasons are same across the school years
$H_1$ : The distribution of delay reasons aren't all the same across the school years.

```{r,echo = FALSE, message=FALSE,warning = FALSE}
#import data
df = read_csv("data/clean_data.csv")

#chi-square test data set: df_1
df_1 = df %>% 
   janitor::clean_names() %>% 
  filter(school_year!="2021-2022") %>%
  select(year,school_year,reason, day,month,prcp:tmin) %>% 
  na.omit() %>% 
  group_by(reason,school_year) %>% 
  summarize(frequency=n())%>%
  mutate(reason = as.factor(reason),
    reason = fct_reorder(reason,frequency,.desc = TRUE)
    ) %>% 
  pivot_wider(
    names_from = "reason",
    values_from = "frequency"
  ) 


#Chi-square test
chisq.test(df_1[,-1]) %>% 
   broom::tidy()

#print the table
knitr::kable(df_1,caption = "Distribution of Delay Reasons across the Years")

```

We can see from the Chi-square test above, we reject the null hypothesis at 99% significant level.This means that the reasons of delay have a different distribution across the school years,though they seem about the same in our bar plots. Our guess is that though the leading reason remains to be heavy traffic, the percentage of heavy traffic being the reason is actually decreasing over the years.

### Chi-Square Testing Homogeneity between Delay Reasons in 2019-2020

Given that the distribution of delay reasons varies from year to year, we decide to look at the nearest pre-pandemic school year. The reason we focus on 2019-2020 school year is that we assume the post pandemic situation should be similar with the nearest pre pandemic situation. 

Looking at the plot in the distribution of delay reasons,we believe that the frequency of different reasons should not be the same. And now we want to verify our assumption using a chi-square test.

```{r}
#creating a dataframe
df_2 = df %>% 
   janitor::clean_names() %>% 
  filter(school_year =="2019-2020") %>%
  select(year,school_year,reason) %>% 
  na.omit() %>% 
  group_by(reason,school_year) %>% 
  summarize(frequency=n())%>%
  mutate(reason = as.factor(reason),
    reason = fct_reorder(reason,frequency,.desc = TRUE)
    ) %>% 
  select(reason,frequency)
  

#chi-square test
 chisq.test(df_2[,-1]) %>% 
  broom::tidy()

#print the table
knitr::kable(df_2,caption = "Distribution of Delay Reasons in 2019-2020")

```
We can see from the chi-square test result we should reject the null hypothesis,the frequency of delay reasons are not equally distributed in 2019-2020 school year.



