---
title: "Maps and Density Heatmaps"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    always_allow_html: true
    css: style.css
---

```{r setup, include=FALSE}
library(tidyverse)
library(httr)
library(plotly)
library(readr)
library(knitr)

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d

```

```{r}
opt_delay = read_csv("./data/opt_delay.csv")%>%
  distinct(school_name,.keep_all = TRUE) 

avergae_delayed = data.frame(opt_delay %>% count(how_long_delayed))
```

# Count Data

There are a total of `r nrow(opt_delay)` schools analyzed in this dataset with complete location data from 2015 and 2021.  

## Average delayed time

There are `r avergae_delayed[[2]][1]` schools with school buses that have delayed average 0-15 minutes.

There are `r avergae_delayed[[2]][2]` schools with school buses that have delayed average 16-30 minutes.

There are `r avergae_delayed[[2]][3]` schools with school buses that have delayed average 31-45 minutes.

There are `r avergae_delayed[[2]][4]` schools with school buses that have delayed average 46-60 minutes.

There are `r avergae_delayed[[2]][4]` schools with school buses that have delayed average 61-90 minutes.

# Maps

These maps include data provided by New York City in the open source crash database and data.world, generated by Plotly Chart Studio and Mapbox geolocation software.

## School bus delayed in New York

This map displays the geolocation of school buses delayed in New York City from 2015 to 2021. 

The school buses on Manhattan averagely have the longer delayed time.

```{r}
# plot
map_school = 
  opt_delay %>%
  mutate(school_delay = str_c(school_name,",",how_long_delayed)) %>%
  plot_ly(
    lat = ~latitude,
    lon = ~longitude,
    color = ~how_long_delayed,
    marker = list(color = "dark"),
    type = 'scattermapbox',
    hovertext = ~school_delay,
    mode   = 'markers')

map_school = 
  map_school %>% 
    layout(
    mapbox = list(
      style = 'open-street-map',
      zoom =9,
      center = list(lon = -73.93, lat = 40.71))) 


map_school 
```

# When we focus on Manhanttan...

```{r}
# plot
map_school_manhattan = 
  opt_delay %>%
  filter(city == "Manhattan") %>%
  mutate(school_delay = str_c(school_name,",",how_long_delayed)) %>%
  plot_ly(
    lat = ~latitude,
    lon = ~longitude,
    color = ~how_long_delayed,
    marker = list(color = "dark"),
    type = 'scattermapbox',
    hovertext = ~school_delay,
    mode   = 'markers')

map_school_manhattan = 
  map_school_manhattan %>% 
    layout(
    mapbox = list(
      style = 'open-street-map',
      zoom =10,
      center = list(lon = -73.96, lat = 40.77))) 

map_school_manhattan 
```

# Density Heatmaps

These maps include data provided by New York City in the open source crash database and data.world, generated by Plotly Chart Studio and Mapbox geolocation software.

```{r}
map_school_manhattan_density = 
  opt_delay %>%
  filter(city == "Manhattan") %>%
  mutate(school_delay = str_c(school_name,",",how_long_delayed)) %>%
  plot_ly(
    lat = ~latitude,
    lon = ~longitude,
    color = ~how_long_delayed,
    marker = list(color = "dark"),
    type = 'densitymapbox',
    radius = 3)

map_school_manhattan_density = 
  map_school_manhattan_density %>% 
    layout(
    mapbox = list(
      style = 'open-street-map',
      zoom =10,
      center = list(lon = -73.96, lat = 40.77)),
    title = "Density Heatmap of School Buses delayed in Manhattan")

map_school_manhattan_density

```

# Summary

Data in these geolocation and density heatmap plots help identify certain schools in New York City that appear to have more server school bus delayed. They are around East Harlem and Lower East Side, as well as the Hudson Yards. 


