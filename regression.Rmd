---
title: "Regression Analysis"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    always_allow_html: true
    css: style.css
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(modelr)
library(ggplot2)
library(viridis)
library(purrr)
knitr::opts_chunk$set(
  fig.height = 6,
  fig.width = 8,
  message = F,
  echo = T,
  warning = F,
  cache = F
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis",
  digits = 3
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
set.seed(1)

```

##  Predicting Model for Daily Delay Account

From previously data exploration and data analysis, we know that there exists some interesting relationship between bus delay and weather,location, and a variety of reasons.Here, we want to explore the dataset more deeper to predict the number of daily delay in Manhattan as our outcome and month, weekday, reasons,daily precipitation,run type of bus, daily snow depth as predictors.

```{r load_data,include=FALSE, message=FALSE,warning = FALSE}
df = read_csv("data/clean_data.csv") %>% 
  janitor::clean_names() %>% 
  mutate(
    reason=as.factor(reason),
    month = as.factor(month),
    day = as.factor(day),
   run_type=as.factor(run_type)) %>% 
 select(boro,occur_date,month,day,prcp,snwd,school_year,tmax,tmin) %>% 
 na.omit()
```


Our interested dependent variable is number of delay across three school years: the amount of delay in Manhattan. We can interpret that this dependent is following poison distribution, so we need to consider regression model for this settings. Based on the graph below, the daily delay across three consecutive school have declined.

```{r,message=FALSE,warning=FALSE}
daily_df = df %>% 
  filter(school_year!="2021-2022",
         boro =="Manhattan") %>% 
   group_by(occur_date,school_year) %>% 
   summarize(n=n()) %>% 
    ggplot(aes(x=occur_date, y=n,fill=school_year))+
    geom_bar(stat='identity')+
    facet_grid(~school_year)+
      labs(
        title = "Number of Daily Delay",
        x = "Date of Delay",
        y = "Count"
      )
daily_df
```

Here’s the predictors in our model:

\ ·**month**: month of the incident occurred;

\ ·**day**: weekday of the incident occurred;

\ ·**reason** : reason for delay as entered by staff employed by reporting bus vendor;

\ ·**prcp**:precipitation (tenths of mm)

\ ·**run_type**:designates whether a breakdown or delay occurred on a specific category of busing service;

\ ·**snwd**: snow depth (mm)

\ ·**tmin** Minimum temperature (tenths of degrees C)



## Fitting Model

We propose 4 models for prediction:

\ 1. Linear Model of daily_delay ~ month + day + snwd + tmin

\ 2. Linear Model of daily_delay ~ month + day  + snwd + tmin+ tmin*day,assuming that there are interaction

\ 3. Linear Model of daily_delay ~ month + day  + prcp
  
\ 4. Step_wise Regression Model of daily_delay ~ month + day + prcp + snwd+ tmin





```{r}
cv_df=df %>% 
  sample_n(size = 100) %>% 
  group_by(occur_date) %>% 
  mutate(daily_delay=n()) %>% 
  modelr::crossv_mc(n = 100) %>%
  mutate_if(is.character, as.factor) %>% 
  mutate(train = map(train, as.tibble), 
         test = map(test, as.tibble)) %>% 
  mutate(lm_1 = map(.x = train,~ lm(daily_delay ~ month + day  + snwd + tmin,data = .x)),
         lm_2 =map(.x = train,~ lm(daily_delay ~ month + day+ snwd + tmin+tmin*day,data = .x)),
         lm_3 =map(.x = train,~ lm(daily_delay ~ month + day+ prcp, data = .x)))
```


```{r}
cv=cv_df %>% 
  select(starts_with("lm")) %>% 
  pivot_longer(
    starts_with("lm"),
    names_to = "model",
    values_to = "data") %>% 
  mutate(data = map(data,broom::tidy))

cv %>%
  filter(model == "lm_1") %>%
  unnest(data) 
```

```{r}
cv %>%
  filter(model == "lm_2") %>%
  unnest(data) 

```

```{r}
cv %>%
  filter(model == "lm_3") %>%
  unnest(data) 
```


```{r}
df_1=df %>% 
  group_by(occur_date) %>% 
  mutate(daily_delay=n()) %>% 
  ungroup(occur_date) %>% 
  select(everything())

multi.fit=lm(daily_delay~month + day + prcp  + snwd+ tmin, data=df_1)

summary(multi.fit)
step(multi.fit, direction='both')
```

## Cross Validation 
Predictors we chose above are statistically significant.However,we notice that interaction terms are not contributing to model predictability.We would say lm_1 and lm_3 might be a bit better than lm-2.
```{r,message=FALSE}
cv_df %>% 
  mutate(
    rmse_lm1 = map2_dbl(lm_1, test, ~rmse(model = .x, data = .y)),
    rmse_lm2 = map2_dbl(lm_2, test, ~rmse(model = .x, data = .y)),
    rmse_lm3 = map2_dbl(lm_3, test, ~rmse(model = .x, data = .y))) %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()


```

## Model Conclusion

Month,rainfall,snow depth, and day are good predictors for anticipating the number of daily delay in Manhattan.



